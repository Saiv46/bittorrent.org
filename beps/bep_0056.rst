:BEP: 56
:Title: Extension for Peers to Send Metadata Files
:Version: $Revision$
:Last-Modified: $Date$
:Author:  Alexander Ivanov <saiv46@yandex.ru>
:Status:  Draft
:Type:    Standards Track
:Created: 31-Sep-2021
:Post-History: 

Abstract
========
This extension adds a capability for clients to enable compression of
data streams, effectively improving bandwidth for clients supporting it.

Rationale
=========
This extension would allow clients to download files faster, without
using file archivers. Since large files are often precompressed before
torrent creation, downloaders needs to keep both the archives
(for seeding) and uncompresed files (for own usage).

Most users prefer to remove such torrents, thus harming proper file
distribution. For example: Organizations using bittorrent for software
distribution needs to have centralized storage for new customers, no
matter how many customers already have same software.

Extension header
================

This extension uses the extension protocol (specified in `BEP 0010`_)
to advertize client capability of using chunk compression. It defines
following items in the extension protocol handshake message:
+-------+-----------------------------------------------------------+
| name  | description                                               |
+=======+===========================================================+
| c     | Dictionary of supported compression algorithm which maps  |
|       | its identifiers to its priority (unsigned 8-bit integer), |
|       | clients can adjust it based on compression speed/ratio,   |
|       | hardware support, performance and power mode, et cetera.  |
|       | Priority set to zero means that the compression algorithm |
|       | is not supported or disabled by user, The client should   |
|       | ignore any algorithms it doesn't recognize/malformed.     |
+-------+-----------------------------------------------------------+
| cp    | Optional field with prefered compression algorithm.       |
|       | If client supports that algorithm and it's not disabled,  |
|       | then it must expect to recieve pieces compressed by that  |
|       | specified algorithm.                                      |
+-------+-----------------------------------------------------------+



Compression algorithm is selected by taking dictionary item with highest
priority from intersection of items supported by both peers, if there
isn't any suitable compression algorithm - compression will be disabled.

Example of extension handshake message:

::

    {
		'c': {
			'lz4': 21,
			'zstd': 16,
			'density': 7
		},
		'cp': 'zstd'
	}


Stream compression
=================
Compression can't be efficient on pieces less than 4 MB, so whole stream is
being compressed instead by clients. During handshake, clients should lower
or raise algorithm's priority depending on expected compression ratio or
any other factors that could impact compression efficiency and performance.
After compression algorithm is negotiated, whole stream is being compressed.

If client is caching seeding/recieved pieces in memory, then pieces can be
stored compressed, decompressing when saving to disk or sending to peer
which not supports that compression. To avoid re-compression pieces when
sending, client can specify ``cp`` field during handshake.

Allowed compression algorithms
------------------------------

Compression algorithms must satisfy following requirements:

1. Decompression speed must not be lower than 500MB/s.

2. It must not produce larger piece than original by 1%.

+-------------+-----------------------------+
| identifier  | compression algorithm       |
+=============+=============================+
| lz4         | LZ4                         |
+-------------+-----------------------------+
| density     | Chameleon (DENSITY library) |
+-------------+-----------------------------+
| zstd        | ZStandard                   |
+-------------+-----------------------------+

NOTE: Only ``zstd`` compression required to be implemented to use compression.

References
==========

.. _`BEP 0010`: http://www.bittorrent.org/beps/bep_0010.html


Copyright
=========

This document has been placed in the public domain.


..
   Local Variables:
   mode: indented-text
   indent-tabs-mode: nil
   sentence-end-double-space: t
   fill-column: 70
   coding: utf-8
   End:
